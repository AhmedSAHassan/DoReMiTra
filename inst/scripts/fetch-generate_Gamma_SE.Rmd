---
title: "fetch$generate_GammaRay_SE"
output: html_document
date: "2025-06-16"
---

# Loading required packages

```{r}
library(readxl)
library(GEOquery)
library(SummarizedExperiment)
library(dplyr)
library(S4Vectors)
```

# Fetching Gamma ray datasets

```{r}
fetch_geo_datasets <- function(
    excel_path,
    sheet = 1,
    Rad = c("Gamma", "X-ray", "Neutron"),
    accession_col = "Accession_no",
    treatment_col = "Treatment",
    envir = .GlobalEnv) {
  Rad <- match.arg(Rad)

  # Read Excel sheet
  df <- read_excel(excel_path, sheet = sheet)

  # Filter by selected radiation type (Treatment column)
  df <- df[df[[treatment_col]] == Rad, ]

  if (nrow(df) == 0) {
    stop(sprintf("No datasets found for radiation type '%s' in column '%s'.", Rad, treatment_col))
  }

  failed <- c()

  for (i in seq_len(nrow(df))) {
    accession <- trimws(df[[accession_col]][i])
    treatment <- gsub("[^A-Za-z0-9_]", "_", trimws(df[[treatment_col]][i]))

    if (is.na(accession) || accession == "") {
      warning(sprintf("Skipping row %d with empty accession.", i))
      next
    }

    message(sprintf("üì¶ Fetching %s (%s)...", accession, treatment))

    tryCatch(
      {
        gse <- getGEO(accession, GSEMatrix = TRUE)

        # Unwrap if list of length 1
        if (is.list(gse) && length(gse) == 1 && inherits(gse[[1]], "ExpressionSet")) {
          gse <- gse[[1]]
        }

        if (inherits(gse, "ExpressionSet")) {
          se <- makeSummarizedExperimentFromExpressionSet(gse)
          rownames(se) <- rownames(exprs(gse))
          obj_name <- paste0(treatment, "_", accession)
          assign(obj_name, se, envir = envir)
        } else {
          warning(sprintf("‚ö†Ô∏è %s did not return a valid ExpressionSet.", accession))
          failed <- c(failed, accession)
        }
      },
      error = function(e) {
        warning(sprintf("‚ùå Failed to fetch %s: %s", accession, e$message))
        failed <- c(failed, accession)
      }
    )
  }

  if (length(failed) > 0) {
    message("‚ö†Ô∏è These accession numbers failed to fetch:")
    print(unique(failed))
  }
}
```


```{r}
fetch_geo_datasets(
  excel_path = "~/DoReMiTra/inst/extdata/Curated_datasets.xlsx",
  Rad = "Gamma"
)
```

# Generating counts, rowData, colData RDS objects for each dataset
```{r}
extract_and_save_SE_parts <- function(prefix = "Gamma_GSE", output_dir = ".") {
  se_objects <- ls(envir = .GlobalEnv, pattern = paste0("^", prefix))

  # List of possible gene symbol column names to check, in order
  possible_gene_cols <- c("GENE_SYMBOL", "Gene.Symbol", "ILMN_Gene", "GeneSymbol")

  for (obj_name in se_objects) {
    se <- get(obj_name, envir = .GlobalEnv)

    if (!inherits(se, "SummarizedExperiment")) {
      warning(sprintf("%s is not a SummarizedExperiment. Skipping.", obj_name))
      next
    }

    counts <- assay(se)
    rd <- rowData(se)
    cd <- colData(se)

    # Find first gene symbol column that exists
    gene_symbol_col <- NULL
    for (col_name in possible_gene_cols) {
      if (col_name %in% colnames(rd)) {
        gene_symbol_col <- col_name
        break
      }
    }

    if (!is.null(gene_symbol_col)) {
      gene_symbols <- as.character(rd[[gene_symbol_col]])
      valid_symbols <- !is.na(gene_symbols) & gene_symbols != ""

      # Filter for valid gene symbols
      counts <- counts[valid_symbols, , drop = FALSE]
      gene_symbols <- gene_symbols[valid_symbols]
      rd <- rd[valid_symbols, , drop = FALSE]

      # Average counts by gene symbol
      counts_sum <- rowsum(counts, group = gene_symbols)
      counts_n <- table(gene_symbols)
      counts_avg <- sweep(counts_sum, 1, counts_n, FUN = "/")
      rownames(counts_avg) <- rownames(counts_sum)

      # Aggregate rowData by gene symbol, take first probe‚Äôs metadata per gene
      rd_df <- as.data.frame(rd)
      rd_df$GENE_SYMBOL_AGG <- gene_symbols
      rd_agg_df <- rd_df %>%
        group_by(GENE_SYMBOL_AGG) %>%
        slice(1) %>%
        ungroup()
      rd_agg_df$GENE_SYMBOL_AGG <- NULL

      rd_agg <- S4Vectors::DataFrame(rd_agg_df)

      # Assign outputs
      counts <- counts_avg
      rd <- rd_agg
    } else {
      warning(sprintf("None of the gene symbol columns found in rowData for %s. Keeping original counts and rowData.", obj_name))
    }

    # Save files
    file_base <- file.path(output_dir, obj_name)

    saveRDS(counts, paste0(file_base, "_counts.RDS"))
    saveRDS(rd, paste0(file_base, "_rowData.RDS"))
    saveRDS(cd, paste0(file_base, "_colData.RDS"))

    message(sprintf("‚úÖ Saved averaged components of %s to RDS files.", obj_name))
  }
}
```

```{r}
extract_and_save_SE_parts(prefix = "Gamma_GSE", output_dir = "inst/extdata/Gamma_ray")
```

# Creating a SE object for each dataset

```{r}
assemble_SE_from_RDS <- function(input_dir = "inst/extdata/X-Gamma_ray", prefix = "Gamma_GSE") {
  # List all files in directory
  all_files <- list.files(input_dir, pattern = paste0("^", prefix), full.names = TRUE)

  # Extract unique base names (without suffix)
  get_base_name <- function(f) {
    bn <- basename(f)
    sub("(_counts|_rowData|_colData)\\.RDS$", "", bn)
  }

  base_names <- unique(sapply(all_files, get_base_name))

  se_list <- list()

  for (base in base_names) {
    counts_file <- file.path(input_dir, paste0(base, "_counts.RDS"))
    rowData_file <- file.path(input_dir, paste0(base, "_rowData.RDS"))
    colData_file <- file.path(input_dir, paste0(base, "_colData.RDS"))

    if (!all(file.exists(c(counts_file, rowData_file, colData_file)))) {
      warning(sprintf("Missing one or more RDS files for %s. Skipping.", base))
      next
    }

    counts <- readRDS(counts_file)
    rd <- readRDS(rowData_file)
    cd <- readRDS(colData_file)

    # Make sure colnames and rownames match
    if (!all(colnames(counts) == rownames(cd))) {
      stop(sprintf("Column names of counts and rownames of colData do not match for %s.", base))
    }
    if (!all(rownames(counts) == rownames(rd))) {
      stop(sprintf("Row names of counts and rowData do not match for %s.", base))
    }

    se <- SummarizedExperiment(assays = list(counts = counts), rowData = rd, colData = cd)
    se_list[[base]] <- se
  }

  return(se_list)
}
```

```{r}
Gamma_se_objects <- assemble_SE_from_RDS(input_dir = "inst/extdata/Gamma_ray", prefix = "Gamma_GSE")
```

# Saving RDS object for each generated SE

```{r}
save_SE_list_as_RDS <- function(se_list, output_dir = ".", prefix = "SE_object") {
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }

  for (i in seq_along(se_list)) {
    se <- se_list[[i]]

    if (!inherits(se, "SummarizedExperiment")) {
      warning(sprintf("Element %d is not a SummarizedExperiment. Skipping.", i))
      next
    }

    # Use names if available, else generic name with prefix and index
    obj_name <- if (!is.null(names(se_list)) && names(se_list)[i] != "") {
      names(se_list)[i]
    } else {
      paste0(prefix, i)
    }

    file_path <- file.path(output_dir, paste0(obj_name, ".RDS"))
    saveRDS(se, file_path)

    message(sprintf("‚úÖ Saved %s as a single RDS file.", obj_name))
  }
}
```

```{r}
save_SE_list_as_RDS(Gamma_se_objects, output_dir = "inst/extdata/SE_objects", prefix = "Gamma_GSE")
```
