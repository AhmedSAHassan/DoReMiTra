---
title: "Make_DoReMiTra_Metadata"
author: "Ahmed Hassan"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r}

#' Generate metadata.csv for ExperimentHub submission
#'
#' @param se_list A named list of SummarizedExperiment objects
#' @param rdata_path_base Path relative to inst/extdata or inst/ directory where .RDS files will be saved
#' @param output_path Path to save the resulting metadata.csv file (e.g. "inst/extdata/metadata.csv")
#' @param source_version Optional, version label for datasets (default = current date)
#' @return A data.frame of metadata written to disk
#' @export
#' 
#' 
generate_experimenthub_metadata <- function(
  se_list,
  rdata_path_base = "DoReMiTra/SE",  # path inside the package
  output_path = "inst/extdata/metadata.csv",
  source_version = Sys.Date()
) {
  metadata_entries <- lapply(names(se_list), function(se_name) {
    se <- se_list[[se_name]]

    # Infer accession
    accession <- stringr::str_extract(se_name, "GSE\\d+")

    # Infer species (can be multiple)
    organisms <- unique(as.character(SummarizedExperiment::colData(se)$Organism))
    species <- paste(sort(organisms), collapse = "; ")

    # Infer radiation type
    if ("Radiation_type" %in% colnames(SummarizedExperiment::colData(se))) {
      rad_types <- unique(SummarizedExperiment::colData(se)$Radiation_type)
      radiation <- paste(sort(rad_types), collapse = "; ")
    } else {
      radiation <- NA
    }

    # Title and Description
    title <- glue::glue("{se_name} expression dataset")
    description <- glue::glue("Processed expression data from GEO series {accession} related to {radiation} exposure.")

    # Metadata row
    data.frame(
      Title = title,
      Description = description,
      RDataPath = file.path(rdata_path_base, paste0(se_name, ".RDS")),
      BiocVersion = "3.19",  # adjust depending on target Bioconductor release
      SourceType = "GEO",
      SourceUrl = paste0("https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=", accession),
      SourceVersion = as.character(source_version),
      Species = species,
      DataProvider = "GEO",
      Maintainer = "Ahmed Hassan <ahhassan@uni-mainz.de>",
      RDataClass = "SummarizedExperiment",
      DispatchClass = "RDS",
      stringsAsFactors = FALSE
    )
  })

  # Combine and write to file
  DoReMiTra_metadata_df <- do.call(rbind, metadata_entries)
  readr::write_csv(DoReMiTra_metadata_df, output_path)
  message("âœ… Bioconductor ExperimentHub metadata written to: ", output_path)

  return(DoReMiTra_metadata_df)
}


```

```{r}
DoReMiTra_metadata <- generate_experimenthub_metadata(
    se_list = all_se_list,
    rdata_path_base = "DoReMiTra/SE",
    output_path = "inst/extdata/DoReMiTra_metadata.csv"
)
```

