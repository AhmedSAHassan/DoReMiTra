---
title: "filter_metadata"
output: html_document
date: "2025-06-25"
---
```{r}
#' Generate Filtering Metadata from SE List
#'
#' @param se_list A named list of SummarizedExperiment objects (e.g. all_se_list)
#' @param output_path Path to save the filtering metadata (e.g. "inst/extdata/filtering_metadata.tsv")
#' @return A data.frame with filtering metadata
#' @export
generate_filtering_metadata <- function(se_list, output_path = "inst/extdata/filtering_metadata.csv") {
  stopifnot(dir.exists(dirname(output_path)))

  metadata_df <- do.call(rbind, lapply(names(se_list), function(se_name) {
    se <- se_list[[se_name]]

    # Attempt to extract metadata fields from colData
    col_data <- SummarizedExperiment::colData(se)

    # Handle multiple values (e.g., organisms) by collapsing
    organism <- if ("Organism" %in% colnames(col_data)) {
      paste(unique(as.character(col_data$Organism)), collapse = "; ")
    } else {
      NA
    }

    radiation_type <- if ("Radiation_type" %in% colnames(col_data)) {
      paste(unique(as.character(col_data$Radiation_type)), collapse = "; ")
    } else {
      NA
    }

    exp_setting <- if ("Exp_setting" %in% colnames(col_data)) {
      paste(unique(as.character(col_data$Exp_setting)), collapse = "; ")
    } else if (grepl("_vitro_", se_name)) {
      "vitro"
    } else if (grepl("_vivo_", se_name)) {
      "vivo"
    } else {
      NA
    }

    accession <- stringr::str_extract(se_name, "GSE\\d+")

    data.frame(
      DatasetName = se_name,
      Radiation_type = radiation_type,
      Exp_setting = exp_setting,
      Organism = organism,
      Accession = accession,
      RDataPath = file.path("DoReMiTra/SE", paste0(se_name, ".RDS")),
      stringsAsFactors = FALSE
    )
  }))

  # Save to disk
  readr::write_csv(metadata_df, output_path)
  message("âœ… Filtering metadata saved to: ", output_path)

  return(metadata_df)
}

```

```{r}

filtering_metadata <- generate_filtering_metadata(all_se_list, output_path = "inst/extdata/filtering_metadata.csv")

```

